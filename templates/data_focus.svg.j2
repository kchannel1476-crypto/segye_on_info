{# templates/data_focus.svg.j2 #}
<svg xmlns="http://www.w3.org/2000/svg" width="{{ canvas.w }}" height="{{ canvas.h }}" viewBox="0 0 {{ canvas.w }} {{ canvas.h }}">
  <defs>
    <style>
      .bg { fill: #ffffff; }
      .ink { fill: #111111; }
      .muted { fill: #444444; }
      .muted2 { fill: #666666; }
      .line { stroke: #E6E6E6; stroke-width: 2; }
      .card { fill: #F7F7F7; stroke: #E7E7E7; stroke-width: 2; rx: 18; ry: 18; }
      .badge { fill: #111111; rx: 12; ry: 12; }
      .badgeText { fill: #ffffff; font-size: 18px; font-weight: 700; letter-spacing: 0.2px; }
      .h1 { fill: #111111; font-size: 54px; font-weight: 800; letter-spacing: -0.6px; }
      .dek { fill: #333333; font-size: 24px; font-weight: 500; letter-spacing: -0.2px; }
      .kpiVal { fill: #111111; font-size: 44px; font-weight: 800; letter-spacing: -0.4px; }
      .kpiLabel { fill: #333333; font-size: 20px; font-weight: 700; letter-spacing: -0.2px; }
      .kpiNote { fill: #555555; font-size: 18px; font-weight: 500; letter-spacing: -0.1px; }
      .kpNum { fill: #ffffff; font-size: 16px; font-weight: 800; }
      .kpNumBg { fill: #111111; rx: 10; ry: 10; }
      .kpText { fill: #111111; font-size: 22px; font-weight: 600; letter-spacing: -0.2px; }
      .src { fill: #666666; font-size: 18px; font-weight: 500; }
      .up { fill: #C62828; }
      .down { fill: #1565C0; }
      .neutral { fill: #111111; }
    </style>
  </defs>

  {# --- Base --- #}
  <rect class="bg" x="0" y="0" width="{{ canvas.w }}" height="{{ canvas.h }}"/>

  {% set M = canvas.margin %}
  {% set W = canvas.w %}
  {% set H = canvas.h %}

  {# --- Header --- #}
  <g id="header" transform="translate({{ M }}, {{ M }})">
    <rect class="badge" x="0" y="0" width="104" height="30" rx="12" ry="12"/>
    <text class="badgeText" x="14" y="22">DATA</text>

    <text class="h1" x="0" y="92">{{ text.headline }}</text>

    {% if text.dek %}
      <text class="dek" x="0" y="132">{{ text.dek }}</text>
    {% endif %}

    <line class="line" x1="0" y1="170" x2="{{ W - (M*2) }}" y2="170"/>
  </g>

  {# --- KPI Cards Grid --- #}
  {% set gridX = M %}
  {% set gridY = M + 220 %}
  {% set gridW = W - (M*2) %}
  {% set gap = 24 %}
  {% set cardW = (gridW - gap) / 2 %}
  {% set cardH = 170 %}

  {% set nums = numbers if numbers else [] %}

  <g id="kpi_grid" transform="translate({{ gridX }}, {{ gridY }})">
    {% if nums|length == 0 %}
      <rect class="card" x="0" y="0" width="{{ gridW }}" height="{{ cardH }}" />
      <text class="kpiLabel" x="28" y="56">수치 데이터가 충분하지 않습니다</text>
      <text class="kpiNote" x="28" y="92">본문에서 숫자/비율/금액/인원 등을 찾지 못했어요.</text>
    {% else %}
      {% for n in nums[:4] %}
        {% set col = (loop.index0 % 2) %}
        {% set row = (loop.index0 // 2) %}
        {% set x = col * (cardW + gap) %}
        {% set y = row * (cardH + gap) %}
        <g class="kpi_card">
          <rect class="card" x="{{ x }}" y="{{ y }}" width="{{ cardW }}" height="{{ cardH }}" />
          <text class="kpiLabel" x="{{ x + 28 }}" y="{{ y + 52 }}">{{ n.label }}</text>
          <text class="kpiVal {{ n.trend }}" x="{{ x + 28 }}" y="{{ y + 108 }}">{{ n.value }}{{ n.unit }}</text>
          {% if n.trend == "up" %}
          <text x="{{ x + cardW - 60 }}" y="{{ y + 108 }}" font-size="24">▲</text>
          {% elif n.trend == "down" %}
          <text x="{{ x + cardW - 60 }}" y="{{ y + 108 }}" font-size="24">▼</text>
          {% endif %}
          {% if n.note %}
            <text class="kpiNote" x="{{ x + 28 }}" y="{{ y + 144 }}">{{ n.note }}</text>
          {% endif %}
        </g>
      {% endfor %}
    {% endif %}
  </g>

  {% if chart and chart["type"] == "donut" and (chart["items"]|length) == 2 %}
  <g id="donut_chart" transform="translate({{ M }}, {{ gridY + (cardH*2) + 10 }})">
    <text class="kpiLabel" x="0" y="0">구성 비율</text>

    {% set total = chart["items"][0]["value"] + chart["items"][1]["value"] %}
    {% set ratio = chart["items"][0]["value"] / total %}

    <circle cx="240" cy="100" r="70" stroke="#EEE" stroke-width="20" fill="none"/>
    <circle cx="240" cy="100" r="70"
            stroke="#111" stroke-width="20"
            stroke-dasharray="{{ (440 * ratio)|int }} 440"
            transform="rotate(-90 240 100)"
            fill="none"/>

    <text class="kpiLabel" x="330" y="90">{{ chart.items[0].label }}</text>
    <text class="kpiLabel" x="330" y="120">{{ chart.items[1].label }}</text>
  </g>
  {% elif chart and chart["items"] and (chart["items"]|length) >= 2 %}
  {% set chartY = gridY + (cardH*2) + gap + 10 %}
  {% set chartX = M %}
  {% set chartW = W - (M*2) %}
  {% set barH = 24 %}
  {% set barGap = 26 %}

  <g id="auto_chart" transform="translate({{ chartX }}, {{ chartY }})">
    <text class="kpiLabel" x="0" y="0">수치 비교</text>

    {% for item in chart["items"][:4] %}
      {% set yy = 28 + loop.index0 * (barH + barGap) %}
      <text class="kpiLabel" x="0" y="{{ yy + 18 }}">{{ item.label }}</text>

      <rect x="220" y="{{ yy }}" width="{{ chartW - 240 }}" height="{{ barH }}"
            fill="#EFEFEF" rx="12" ry="12"/>

      <rect x="220" y="{{ yy }}" width="{{ (chartW - 240) * item.norm }}"
            height="{{ barH }}" fill="#111111" rx="12" ry="12"/>

      <text class="kpiNote" x="{{ chartW - 100 }}" y="{{ yy + 18 }}">
        {{ item.value }}
      </text>
    {% endfor %}
  </g>
  {% endif %}

  {# --- Key Points (2개만 노출) --- #}
  {% set kpY = gridY + (cardH*2) + gap + 180 %}
  {% set kpX = M %}
  {% set kpW = W - (M*2) %}

  <g id="key_points" transform="translate({{ kpX }}, {{ kpY }})">
    <text class="kpiLabel" x="0" y="0">핵심 포인트</text>

    {% set kp = text.key_points if text.key_points else [] %}
    {% set kp2 = (kp + ["",""])[:2] %}

    {% for t in kp2 %}
      {% set yy = 42 + loop.index0 * 70 %}
      <rect class="kpNumBg" x="0" y="{{ yy - 22 }}" width="34" height="34" rx="10" ry="10"/>
      <text class="kpNum" x="12" y="{{ yy + 2 }}">{{ loop.index }}</text>
      <text class="kpText" x="52" y="{{ yy + 6 }}">{{ t }}</text>
    {% endfor %}
  </g>

  {# --- Footer / Sources --- #}
  <g id="footer" transform="translate({{ M }}, {{ H - M - 24 }})">
    <text class="src" x="0" y="18">{{ text.sources_line }}</text>
  </g>
</svg>
